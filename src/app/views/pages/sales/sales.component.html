<!-- شريط الأدوات -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>اجمالى الطلبيات </h4>
  <div class="d-flex gap-2">
    <input type="text" class="form-control" placeholder="بحث بالعميل أو رقم الطلب" />
    <select class="form-select">
      <option>قيد الدراسه</option>
      <option>تم الاتفاق مع مورد</option>
      <option>مستحقة الدفع</option>
      <option>مكتملة</option>
    </select>
<button class="btn btn-primary" (click)="openNewOrderForm()">
  طلب جديد
</button>  </div>
</div>

<!-- الإحصائيات -->
<c-row class="mb-4 text-center">
  <c-col sm="6" md="3">
    <c-widget-stat-c
      color="info"
        [value]="getCountByStatus('قيد الدراسة') + ''"
      title="قيد الدراسة"
      inverse>
    </c-widget-stat-c>
  </c-col>

  <c-col sm="6" md="3">
    <c-widget-stat-c
      color="primary"
      [value]="supplierAgreed"
      [value]="getCountByStatus('تم الاتفاق مع المورد') + ''"
      title="تم الاتفاق مع المورد"
      inverse>
    </c-widget-stat-c>
  </c-col>

  <c-col sm="6" md="3">
    <c-widget-stat-c
      color="warning"
      [value]="receivedNotPaid"
      [value]="getCountByStatus('مستحقة الدفع') + ''"
      title="مستحقة الدفع"
      inverse>
    </c-widget-stat-c>
  </c-col>

  <c-col sm="6" md="3">
    <c-widget-stat-c
      color="success"
      [value]="getCountByStatus('مكتمل') + ''"
      title="مكتمل"
      inverse>
    </c-widget-stat-c>
  </c-col>
</c-row>

<div class="card mt-3 mb-3" *ngIf="showOrderForm">
  <div class="card-body">
    <h5 class="mb-3">إضافة طلب جديد</h5>

    <form [formGroup]="orderForm" (ngSubmit)="submitOrder()">

  <!-- MAIN INFO ROW -->
  <div class="row mb-3">
    <!-- Project Name -->
    <div class="col-md-4">
      <label class="form-label">اسم المشروع</label>
      <input
        class="form-control"
        formControlName="projectName"
        placeholder="اختياري"
      />
    </div>

    <!-- Supplier Name -->
    <div class="col-md-4">
      <label class="form-label">اسم المورد</label>
      <input
        class="form-control"
        formControlName="supplierName"
        placeholder="اختياري"
      />
    </div>

    <!-- Arrival Time -->
    <div class="col-md-4">
      <label class="form-label">موعد الوصول المطلوب</label>
      <input
        type="date"
        class="form-control"
        formControlName="arrivedNeededTime"
      />
    </div>
  </div>

  <hr />

  <!-- COMPONENTS -->
  <h6>المكونات</h6>

  <div formArrayName="components">
    <div
      class="border rounded p-3 mb-2"
      *ngFor="let comp of components.controls; let i = index"
      [formGroupName]="i"
    >
      <div class="row">
        <div class="col-md-4">
          <label>Model Number *</label>
          <input class="form-control" formControlName="modelNum" />
        </div>

        <div class="col-md-4">
          <label>Component Name *</label>
          <input class="form-control" formControlName="name" />
        </div>

        <div class="col-md-3">
          <label>Num of Units *</label>
          <input
            type="number"
            class="form-control"
            formControlName="units"
            min="1"
          />
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <button
  type="button"
  class="btn btn-danger btn-sm"
  (click)="removeNewOrderComponent(i)"
>
  ✕
</button>

        </div>
      </div>

      <div class="mt-2">
        <label>Note</label>
        <input class="form-control" formControlName="note" />
      </div>
    </div>
  </div>

  <button
    type="button"
    class="btn btn-outline-secondary btn-sm mb-3"
    (click)="addNewOrderComponent()"
  >
    + إضافة مكون
  </button>

  <div class="d-flex justify-content-end gap-2">
    <button type="submit" class="btn btn-success" [disabled]="orderForm.invalid">
      حفظ
    </button>
    <button type="button" class="btn btn-light" (click)="cancelForm()">
      إلغاء
    </button>
  </div>

</form>

  </div>
</div>

<div>
  <div class="order-row card mb-2 shadow-sm" *ngFor="let order of filteredOrders">

    <!-- MAIN ROW -->
    <div class="card-body d-flex justify-content-between align-items-center cursor-pointer"
         (click)="toggleOrder(order.id)">
      <div><strong>#{{ order.id }}</strong></div>
      <div>{{ order.projectName || 'بدون مشروع' }}</div>
      <div>{{ order.supplierName || 'بدون مورد' }}</div>
      <div>{{ order.arrivedNeededTime }}</div>

      <c-badge [color]="getStatusColor(order.status)">{{ order.status }}</c-badge>
    </div>

    <!-- TOGGLED DETAILS -->
    <div *ngIf="expandedOrderId === order.id" class="card-body border-top bg-light" [formGroup]="orderForms[order.id]">
      
      <div class="row mb-3">
        <div class="col-md-4"><strong>تم الانشاء:</strong> {{ order.createdAt }}</div>
        <div class="col-md-4"><strong>أنشئ بواسطة:</strong> {{ order.createdBy }}</div>
        <div class="col-md-4" *ngIf="editingOrderId !== order.id"><strong>وقت التسليم:</strong>{{ order.arrivedNeededTime }}</div>
        <div class="col-md-4" *ngIf="editingOrderId === order.id">
          <input type="date" class="form-control" formControlName="arrivedNeededTime" />
        </div>
      </div>

      <!-- Project Name & Supplier Name -->
      <div class="row mb-3" *ngIf="editingOrderId === order.id">
        <div class="col-md-6">
          <label>اسم المشروع</label>
<input class="form-control" formControlName="projectName" />
        </div>
        <div class="col-md-6">
          <label>اسم المورد</label>
<input class="form-control" formControlName="supplierName" />
        </div>
      </div>

      <!-- COMPONENTS TABLE -->
      <table class="table table-sm table-bordered" *ngIf="editingOrderId !== order.id">
        <thead>
          <tr>
            <th>#</th>
            <th>Model Number</th>
            <th>Note</th>
            <th>Price (EGP)</th>
            <th>Units</th>
            <th>Total (EGP)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let comp of order.components">
            <td>{{ comp.id }}</td>
            <td>{{ comp.modelNum }}</td>
            <td>{{ comp.note }}</td>
            <td>{{ comp.price || 'غير محدد' }}</td>
            <td>{{ comp.units }}</td>
            <td>{{ comp.price * comp.units || 'غير محدد' }}</td>
          </tr>
        </tbody>
      </table>

      <!-- Editable components -->
      <div *ngIf="editingOrderId === order.id" formArrayName="components">
        <div class="mb-2" *ngFor="let comp of getComponents(order.id).controls; let i = index" [formGroupName]="i">
          <div class="row">
  <div class="col-md-2">
    <input class="form-control" formControlName="modelNum" placeholder="Model Number"/>
  </div>
  <div class="col-md-2">
    <input class="form-control" formControlName="name" placeholder="Component Name"/>
  </div>
  <div class="col-md-2">
    <input class="form-control" formControlName="note" placeholder="Note"/>
  </div>
  <div class="col-md-2">
    <input type="number" class="form-control" formControlName="units" placeholder="Units" min="1"/>
  </div>
  <div class="col-md-2">
    <input type="number" class="form-control" formControlName="price" placeholder="Price"/>
  </div>
  <div class="col-md-1 d-flex align-items-center">
    <button type="button" class="btn btn-danger btn-sm" (click)="removeComponent(order.id, i)">✕</button>
  </div>
</div>

        </div>
        <button type="button" class="btn btn-outline-secondary btn-sm mb-2" (click)="addComponent(order.id)">
          + إضافة مكون
        </button>
      </div>

      <hr />
      <div class="col-md-3"><strong>إجمالي السعر:</strong> {{ order.totalPrice }} EGP</div>

      <!-- Edit / Save / Cancel Buttons -->
      <div class="d-flex justify-content-end gap-2 mt-2">
        <button type="button" class="btn btn-primary" *ngIf="editingOrderId !== order.id" 
                (click)="startEdit(order.id)">Edit</button>
        <button type="button" class="btn btn-success" *ngIf="editingOrderId === order.id" 
                (click)="saveOrder(order.id)">Save</button>
        <button type="button" class="btn btn-light" *ngIf="editingOrderId === order.id" 
                (click)="cancelEdit(order.id)">Cancel</button>
      </div>
    </div>
  </div>
</div>



<h4 class="mt-5 mb-3">الموردين المعتمدين</h4>

<div class="row g-4" style="margin-bottom: 40px">
  <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2" *ngFor="let supplier of approvedSuppliers">
    <div class="card h-100 shadow-sm text-center p-3 border-0 hover-shadow" style="cursor: pointer;">
      <img [src]="supplier.image" alt="{{ supplier.name }}" class="rounded-circle mx-auto mb-3" style="width: 100px; height: 100px; object-fit: fill;" />
      <h6 class="mb-0">{{ supplier.name }}</h6>
    </div>
  </div>
</div>
